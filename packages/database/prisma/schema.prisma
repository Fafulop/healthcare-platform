// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User authentication model for staff (doctors + admins)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?  // Google profile picture
  role      Role     @default(DOCTOR)

  // Optional: Link to doctor profile if user is a doctor
  doctorId  String?  @unique @map("doctor_id")
  doctor    Doctor?  @relation(fields: [doctorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

// Role enum for staff members
enum Role {
  ADMIN
  DOCTOR
}

model Doctor {
  id                 String   @id @default(cuid())
  slug               String   @unique
  doctorFullName     String   @map("doctor_full_name")
  lastName           String   @map("last_name")
  primarySpecialty   String   @map("primary_specialty")
  subspecialties     String[]
  cedulaProfesional  String?  @map("cedula_profesional")
  heroImage          String   @map("hero_image")
  locationSummary    String   @map("location_summary")
  city               String

  // Biography
  shortBio           String   @map("short_bio") @db.Text
  longBio            String   @map("long_bio") @db.Text
  yearsExperience    Int      @map("years_experience")

  // Lists
  conditions         String[]
  procedures         String[]

  // Appointment info
  nextAvailableDate  DateTime? @map("next_available_date")
  appointmentModes   String[]  @map("appointment_modes")

  // Clinic info (stored as JSON)
  clinicAddress      String    @map("clinic_address")
  clinicPhone        String    @map("clinic_phone")
  clinicWhatsapp     String?   @map("clinic_whatsapp")
  clinicHours        Json      @map("clinic_hours")
  clinicGeoLat       Float?    @map("clinic_geo_lat")
  clinicGeoLng       Float?    @map("clinic_geo_lng")

  // Social links (optional)
  socialLinkedin     String?   @map("social_linkedin")
  socialTwitter      String?   @map("social_twitter")

  // Relations
  user               User?     // 1:1 relation - optional (can have doctors without user accounts)
  services           Service[]
  educationItems     Education[]
  certificates       Certificate[]
  carouselItems      CarouselItem[]
  faqs               FAQ[]
  appointmentSlots   AppointmentSlot[]
  bookings           Booking[]
  articles           Article[]
  reviews            Review[]

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("doctors")
}

// Article model for doctor blog posts
model Article {
  id              String        @id @default(cuid())
  slug            String        @unique

  // Content
  title           String
  excerpt         String        @db.VarChar(200)  // Short summary
  content         String        @db.Text          // Full article (HTML)
  thumbnail       String?                         // Featured image URL

  // Author (Doctor)
  doctorId        String        @map("doctor_id")
  doctor          Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  // Publishing
  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?     @map("published_at") // Null if draft

  // SEO
  metaDescription String?       @db.VarChar(160) @map("meta_description")
  keywords        String[]      // Array of keywords

  // Analytics (Future)
  views           Int           @default(0)

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Indexes for performance
  @@index([doctorId, status])
  @@index([slug])
  @@index([publishedAt])
  @@map("articles")
}

// Article status enum
enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model Service {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  serviceName        String   @map("service_name")
  shortDescription   String   @map("short_description")
  durationMinutes    Int      @map("duration_minutes")
  price              Float?

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("services")
  @@index([doctorId])
}

model Education {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  institution        String
  program            String
  year               String
  notes              String?

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("education")
  @@index([doctorId])
}

model Certificate {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  src                String
  alt                String
  issuedBy           String   @map("issued_by")
  year               String

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("certificates")
  @@index([doctorId])
}

model CarouselItem {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  type               String   // "image" or "video_thumbnail"
  src                String
  thumbnail          String?
  alt                String
  caption            String?

  // Video-specific fields (optional)
  name               String?
  description        String?  @db.Text
  uploadDate         String?  @map("upload_date")
  duration           String?  // ISO 8601 duration format (e.g., "PT45S")

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("carousel_items")
  @@index([doctorId])
}

model FAQ {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  question           String
  answer             String   @db.Text

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("faqs")
  @@index([doctorId])
}

// Appointment Slot - Doctor's availability
model AppointmentSlot {
  id                 String      @id @default(cuid())
  doctorId           String      @map("doctor_id")

  // Date and Time
  date               DateTime    // Date only (normalized to midnight UTC)
  startTime          String      @map("start_time") // "09:00", "14:00"
  endTime            String      @map("end_time")   // "10:00", "15:00"
  duration           Int         // Minutes: 30 or 60

  // Pricing
  basePrice          Decimal     @map("base_price") @db.Decimal(10, 2)
  discount           Decimal?    @db.Decimal(10, 2) // Can be null
  discountType       String?     @map("discount_type") // "PERCENTAGE" | "FIXED"
  finalPrice         Decimal     @map("final_price") @db.Decimal(10, 2)

  // Availability
  status             SlotStatus  @default(AVAILABLE)
  maxBookings        Int         @default(1) @map("max_bookings")
  currentBookings    Int         @default(0) @map("current_bookings")

  // Relations
  doctor             Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  bookings           Booking[]

  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  @@map("appointment_slots")
  @@index([doctorId, date, status])
  @@index([date])
  @@unique([doctorId, date, startTime]) // Prevent duplicate slots at same time
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED
}

// Booking/Appointment - Patient reservation
model Booking {
  id                 String        @id @default(cuid())
  slotId             String        @map("slot_id")
  doctorId           String        @map("doctor_id")

  // Patient Information
  patientName        String        @map("patient_name")
  patientEmail       String        @map("patient_email")
  patientPhone       String        @map("patient_phone")
  patientWhatsapp    String?       @map("patient_whatsapp")

  // Booking Details
  status             BookingStatus @default(PENDING)
  finalPrice         Decimal       @map("final_price") @db.Decimal(10, 2)
  notes              String?       @db.Text

  // Confirmation
  confirmationCode   String?       @unique @map("confirmation_code")
  confirmedAt        DateTime?     @map("confirmed_at")
  cancelledAt        DateTime?     @map("cancelled_at")

  // Review System
  reviewToken        String?       @unique @map("review_token")
  reviewTokenUsed    Boolean       @default(false) @map("review_token_used")

  // Relations
  slot               AppointmentSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  doctor             Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  review             Review?

  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  @@map("bookings")
  @@index([doctorId, status])
  @@index([slotId])
  @@index([patientEmail])
  @@index([reviewToken])
}

enum BookingStatus {
  PENDING       // Just created, awaiting confirmation
  CONFIRMED     // Confirmed (via WhatsApp in future)
  CANCELLED     // Cancelled by patient or doctor
  COMPLETED     // Appointment happened
  NO_SHOW       // Patient didn't show up
}

// Review - Patient reviews for doctors
model Review {
  id                 String    @id @default(cuid())
  doctorId           String    @map("doctor_id")
  bookingId          String?   @unique @map("booking_id") // Optional link to booking

  // Review Content
  patientName        String?   @map("patient_name") // Optional, can be anonymous
  rating             Int       // 1-5 stars
  comment            String    @db.Text

  // Moderation
  approved           Boolean   @default(true) // Auto-approved for MVP

  // Relations
  doctor             Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  booking            Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("reviews")
  @@index([doctorId, approved])
  @@index([bookingId])
}
