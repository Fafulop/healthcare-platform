// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["public", "practice_management", "medical_records"]
}

// User authentication model for staff (doctors + admins)
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  image     String?  // Google profile picture
  role      Role     @default(DOCTOR)

  // Optional: Link to doctor profile if user is a doctor
  doctorId  String?  @unique @map("doctor_id")
  doctor    Doctor?  @relation(fields: [doctorId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
  @@schema("public")
}

// Role enum for staff members
enum Role {
  ADMIN
  DOCTOR

  @@schema("public")
}

model Doctor {
  id                 String   @id @default(cuid())
  slug               String   @unique
  doctorFullName     String   @map("doctor_full_name")
  lastName           String   @map("last_name")
  primarySpecialty   String   @map("primary_specialty")
  subspecialties     String[]
  cedulaProfesional  String?  @map("cedula_profesional")
  heroImage          String   @map("hero_image")
  locationSummary    String   @map("location_summary")
  city               String

  // Biography
  shortBio           String   @map("short_bio") @db.Text
  longBio            String   @map("long_bio") @db.Text
  yearsExperience    Int      @map("years_experience")

  // Lists
  conditions         String[]
  procedures         String[]

  // Appointment info
  nextAvailableDate  DateTime? @map("next_available_date")
  appointmentModes   String[]  @map("appointment_modes")

  // Clinic info (stored as JSON)
  clinicAddress      String    @map("clinic_address")
  clinicPhone        String    @map("clinic_phone")
  clinicWhatsapp     String?   @map("clinic_whatsapp")
  clinicHours        Json      @map("clinic_hours")
  clinicGeoLat       Float?    @map("clinic_geo_lat")
  clinicGeoLng       Float?    @map("clinic_geo_lng")

  // Social links (optional)
  socialLinkedin     String?   @map("social_linkedin")
  socialTwitter      String?   @map("social_twitter")

  // Color palette for personalized branding
  colorPalette       String    @default("warm") @map("color_palette")

  // Relations
  user               User?     // 1:1 relation - optional (can have doctors without user accounts)
  services           Service[]
  educationItems     Education[]
  certificates       Certificate[]
  carouselItems      CarouselItem[]
  faqs               FAQ[]
  appointmentSlots   AppointmentSlot[]
  bookings           Booking[]
  articles           Article[]
  reviews            Review[]

  // Practice Management Relations (NEW)
  areas              Area[]
  clients            Client[]            @relation("DoctorClients")
  proveedores        Proveedor[]         @relation("DoctorProveedores")
  productAttributes  ProductAttribute[]
  products           Product[]
  ledgerEntries      LedgerEntry[]
  quotations         Quotation[]         @relation("DoctorQuotations")
  sales              Sale[]              @relation("DoctorSales")
  purchases          Purchase[]          @relation("DoctorPurchases")

  // Medical Records Relations (EMR)
  patients           Patient[]

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("doctors")
  @@schema("public")
}

// Article model for doctor blog posts
model Article {
  id              String        @id @default(cuid())
  slug            String        @unique

  // Content
  title           String
  excerpt         String        @db.VarChar(200)  // Short summary
  content         String        @db.Text          // Full article (HTML)
  thumbnail       String?                         // Featured image URL

  // Author (Doctor)
  doctorId        String        @map("doctor_id")
  doctor          Doctor        @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  // Publishing
  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?     @map("published_at") // Null if draft

  // SEO
  metaDescription String?       @db.VarChar(160) @map("meta_description")
  keywords        String[]      // Array of keywords

  // Analytics (Future)
  views           Int           @default(0)

  // Timestamps
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Indexes for performance
  @@index([doctorId, status])
  @@index([slug])
  @@index([publishedAt])
  @@map("articles")
  @@schema("public")
}

// Article status enum
enum ArticleStatus {
  DRAFT
  PUBLISHED

  @@schema("public")
}

model Service {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  serviceName        String   @map("service_name")
  shortDescription   String   @map("short_description")
  durationMinutes    Int      @map("duration_minutes")
  price              Float?

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("services")
  @@index([doctorId])
  @@schema("public")
}

model Education {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  institution        String
  program            String
  year               String
  notes              String?

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("education")
  @@index([doctorId])
  @@schema("public")
}

model Certificate {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  src                String
  alt                String
  issuedBy           String   @map("issued_by")
  year               String

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("certificates")
  @@index([doctorId])
  @@schema("public")
}

model CarouselItem {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  type               String   // "image" or "video_thumbnail"
  src                String
  thumbnail          String?
  alt                String
  caption            String?

  // Video-specific fields (optional)
  name               String?
  description        String?  @db.Text
  uploadDate         String?  @map("upload_date")
  duration           String?  // ISO 8601 duration format (e.g., "PT45S")

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("carousel_items")
  @@index([doctorId])
  @@schema("public")
}

model FAQ {
  id                 String   @id @default(cuid())
  doctorId           String   @map("doctor_id")
  question           String
  answer             String   @db.Text

  doctor             Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("faqs")
  @@index([doctorId])
  @@schema("public")
}

// Appointment Slot - Doctor's availability
model AppointmentSlot {
  id                 String      @id @default(cuid())
  doctorId           String      @map("doctor_id")

  // Date and Time
  date               DateTime    // Date only (normalized to midnight UTC)
  startTime          String      @map("start_time") // "09:00", "14:00"
  endTime            String      @map("end_time")   // "10:00", "15:00"
  duration           Int         // Minutes: 30 or 60

  // Pricing
  basePrice          Decimal     @map("base_price") @db.Decimal(10, 2)
  discount           Decimal?    @db.Decimal(10, 2) // Can be null
  discountType       String?     @map("discount_type") // "PERCENTAGE" | "FIXED"
  finalPrice         Decimal     @map("final_price") @db.Decimal(10, 2)

  // Availability
  status             SlotStatus  @default(AVAILABLE)
  maxBookings        Int         @default(1) @map("max_bookings")
  currentBookings    Int         @default(0) @map("current_bookings")

  // Relations
  doctor             Doctor      @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  bookings           Booking[]

  createdAt          DateTime    @default(now()) @map("created_at")
  updatedAt          DateTime    @updatedAt @map("updated_at")

  @@map("appointment_slots")
  @@index([doctorId, date, status])
  @@index([date])
  @@unique([doctorId, date, startTime]) // Prevent duplicate slots at same time
  @@schema("public")
}

enum SlotStatus {
  AVAILABLE
  BOOKED
  BLOCKED

  @@schema("public")
}

// Booking/Appointment - Patient reservation
model Booking {
  id                 String        @id @default(cuid())
  slotId             String        @map("slot_id")
  doctorId           String        @map("doctor_id")

  // Patient Information
  patientName        String        @map("patient_name")
  patientEmail       String        @map("patient_email")
  patientPhone       String        @map("patient_phone")
  patientWhatsapp    String?       @map("patient_whatsapp")

  // Booking Details
  status             BookingStatus @default(PENDING)
  finalPrice         Decimal       @map("final_price") @db.Decimal(10, 2)
  notes              String?       @db.Text

  // Confirmation
  confirmationCode   String?       @unique @map("confirmation_code")
  confirmedAt        DateTime?     @map("confirmed_at")
  cancelledAt        DateTime?     @map("cancelled_at")

  // Review System
  reviewToken        String?       @unique @map("review_token")
  reviewTokenUsed    Boolean       @default(false) @map("review_token_used")

  // Relations
  slot               AppointmentSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  doctor             Doctor          @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  review             Review?

  createdAt          DateTime      @default(now()) @map("created_at")
  updatedAt          DateTime      @updatedAt @map("updated_at")

  @@map("bookings")
  @@index([doctorId, status])
  @@index([slotId])
  @@index([patientEmail])
  @@index([reviewToken])
  @@schema("public")
}

enum BookingStatus {
  PENDING       // Just created, awaiting confirmation
  CONFIRMED     // Confirmed (via WhatsApp in future)
  CANCELLED     // Cancelled by patient or doctor
  COMPLETED     // Appointment happened
  NO_SHOW       // Patient didn't show up

  @@schema("public")
}

// Review - Patient reviews for doctors
model Review {
  id                 String    @id @default(cuid())
  doctorId           String    @map("doctor_id")
  bookingId          String?   @unique @map("booking_id") // Optional link to booking

  // Review Content
  patientName        String?   @map("patient_name") // Optional, can be anonymous
  rating             Int       // 1-5 stars
  comment            String    @db.Text

  // Moderation
  approved           Boolean   @default(true) // Auto-approved for MVP

  // Relations
  doctor             Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  booking            Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@map("reviews")
  @@index([doctorId, approved])
  @@index([bookingId])
  @@schema("public")
}

// ============================================================================
// PRACTICE MANAGEMENT DOMAIN
// ============================================================================

// -----------------------------------------------------------------------------
// 1. CATEGORIZATION (Areas & Subareas)
// -----------------------------------------------------------------------------

model Area {
  id          Int       @id @default(autoincrement())
  doctorId    String    @map("doctor_id")
  name        String    @db.VarChar(255)
  description String?   @db.Text
  type        String    @default("INGRESO") @db.VarChar(10) // "INGRESO" or "EGRESO"
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  doctor      Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  subareas    Subarea[]

  @@unique([doctorId, name])
  @@index([doctorId])
  @@index([doctorId, type])
  @@map("areas")
  @@schema("practice_management")
}

model Subarea {
  id          Int      @id @default(autoincrement())
  areaId      Int      @map("area_id")
  name        String   @db.VarChar(255)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  area        Area     @relation(fields: [areaId], references: [id], onDelete: Cascade)

  @@unique([areaId, name])
  @@index([areaId])
  @@map("subareas")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 2. CRM - CLIENTS
// -----------------------------------------------------------------------------

model Client {
  id              Int      @id @default(autoincrement())
  doctorId        String   @map("doctor_id")

  // Basic Information
  businessName    String   @map("business_name") @db.VarChar(255)
  contactName     String?  @map("contact_name") @db.VarChar(255)
  rfc             String?  @db.VarChar(13)
  email           String?  @db.VarChar(255)
  phone           String?  @db.VarChar(50)

  // Address
  street          String?  @db.VarChar(255)
  city            String?  @db.VarChar(100)
  state           String?  @db.VarChar(100)
  postalCode      String?  @map("postal_code") @db.VarChar(20)
  country         String   @default("México") @db.VarChar(100)

  // Business Details
  industry        String?  @db.VarChar(100)
  notes           String?  @db.Text

  // Status
  status          String   @default("active") @db.VarChar(20)

  // File attachments (logo)
  logoUrl         String?  @map("logo_url") @db.Text
  logoFileName    String?  @map("logo_file_name") @db.VarChar(255)
  logoFileSize    Int?     @map("logo_file_size")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  doctor          Doctor        @relation("DoctorClients", fields: [doctorId], references: [id], onDelete: Cascade)
  quotations      Quotation[]   @relation("ClientQuotations")
  sales           Sale[]        @relation("ClientSales")
  ledgerEntries   LedgerEntry[] @relation("ClientLedgerEntries")

  @@unique([doctorId, businessName])
  @@index([doctorId, status])
  @@index([doctorId, businessName])
  @@map("clients")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 3. CRM - SUPPLIERS (PROVEEDORES)
// -----------------------------------------------------------------------------

model Proveedor {
  id              Int      @id @default(autoincrement())
  doctorId        String   @map("doctor_id")

  // Basic Information (identical to Client)
  businessName    String   @map("business_name") @db.VarChar(255)
  contactName     String?  @map("contact_name") @db.VarChar(255)
  rfc             String?  @db.VarChar(13)
  email           String?  @db.VarChar(255)
  phone           String?  @db.VarChar(50)

  // Address
  street          String?  @db.VarChar(255)
  city            String?  @db.VarChar(100)
  state           String?  @db.VarChar(100)
  postalCode      String?  @map("postal_code") @db.VarChar(20)
  country         String   @default("México") @db.VarChar(100)

  // Business Details
  industry        String?  @db.VarChar(100)
  notes           String?  @db.Text

  // Status
  status          String   @default("active") @db.VarChar(20)

  // File attachments (logo)
  logoUrl         String?  @map("logo_url") @db.Text
  logoFileName    String?  @map("logo_file_name") @db.VarChar(255)
  logoFileSize    Int?     @map("logo_file_size")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  doctor          Doctor        @relation("DoctorProveedores", fields: [doctorId], references: [id], onDelete: Cascade)
  purchases       Purchase[]    @relation("ProveedorPurchases")
  ledgerEntries   LedgerEntry[] @relation("ProveedorLedgerEntries")

  @@unique([doctorId, businessName])
  @@index([doctorId, status])
  @@index([doctorId, businessName])
  @@map("proveedores")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 4. PRODUCT CATALOG - MASTER DATA
// -----------------------------------------------------------------------------

model ProductAttribute {
  id          Int      @id @default(autoincrement())
  doctorId    String   @map("doctor_id")
  name        String   @db.VarChar(100)
  description String?  @db.Text
  order       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  doctor      Doctor                 @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  values      ProductAttributeValue[]

  @@unique([doctorId, name])
  @@index([doctorId, isActive])
  @@index([doctorId, order])
  @@map("product_attributes")
  @@schema("practice_management")
}

model ProductAttributeValue {
  id          Int      @id @default(autoincrement())
  attributeId Int      @map("attribute_id")
  value       String   @db.VarChar(255)
  description String?  @db.Text
  cost        Decimal? @db.Decimal(10, 2)
  unit        String?  @db.VarChar(50)
  order       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  attribute         ProductAttribute   @relation(fields: [attributeId], references: [id], onDelete: Cascade)
  productComponents ProductComponent[]

  @@unique([attributeId, value])
  @@index([attributeId, isActive])
  @@index([attributeId, order])
  @@map("product_attribute_values")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 5. PRODUCT CATALOG - PRODUCTS
// -----------------------------------------------------------------------------

model Product {
  id              Int      @id @default(autoincrement())
  doctorId        String   @map("doctor_id")

  // Product Information
  name            String   @db.VarChar(255)
  sku             String?  @db.VarChar(100)
  category        String?  @db.VarChar(100)
  description     String?  @db.Text

  // Pricing
  price           Decimal? @db.Decimal(10, 2)
  cost            Decimal? @db.Decimal(10, 2)

  // Inventory
  stockQuantity   Int?     @default(0)
  unit            String?  @db.VarChar(50)

  // Status
  status          String   @default("active") @db.VarChar(20)

  // Image
  imageUrl        String?  @map("image_url") @db.Text
  imageFileName   String?  @map("image_file_name") @db.VarChar(255)
  imageFileSize   Int?     @map("image_file_size")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  doctor          Doctor             @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  components      ProductComponent[]
  quotationItems  QuotationItem[]    @relation("QuotationItemProduct")
  saleItems       SaleItem[]         @relation("SaleItemProduct")
  purchaseItems   PurchaseItem[]     @relation("PurchaseItemProduct")

  @@unique([doctorId, name])
  @@index([doctorId, status])
  @@index([doctorId, category])
  @@map("products")
  @@schema("practice_management")
}

model ProductComponent {
  id               Int      @id @default(autoincrement())
  productId        Int      @map("product_id")
  attributeValueId Int      @map("attribute_value_id")
  quantity         Decimal  @db.Decimal(10, 4)
  calculatedCost   Decimal  @db.Decimal(12, 2)
  order            Int      @default(0)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  product        Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  attributeValue ProductAttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([attributeValueId])
  @@map("product_components")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 6. ACCOUNTING - LEDGER (CASH FLOW)
// -----------------------------------------------------------------------------

model LedgerEntry {
  id              Int                @id @default(autoincrement())
  doctorId        String             @map("doctor_id")
  amount          Decimal            @db.Decimal(12, 2)
  concept         String             @db.VarChar(500)
  bankAccount     String?            @map("bank_account") @db.VarChar(255)
  formaDePago     String?            @default("efectivo") @map("forma_de_pago") @db.VarChar(50)
  internalId      String             @map("internal_id") @db.VarChar(100)
  bankMovementId  String?            @map("bank_movement_id") @db.VarChar(255)
  entryType       String             @map("entry_type") @db.VarChar(20)
  transactionDate DateTime           @map("transaction_date") @db.Date
  area            String?            @db.VarChar(255)
  subarea         String?            @db.VarChar(255)
  porRealizar     Boolean            @default(false) @map("por_realizar")

  // Integration with Sales/Purchases
  transactionType String?            @default("N/A") @map("transaction_type") @db.VarChar(20) // "N/A", "COMPRA", "VENTA"
  saleId          Int?               @map("sale_id")
  purchaseId      Int?               @map("purchase_id")
  clientId        Int?               @map("client_id")
  supplierId      Int?               @map("supplier_id")
  paymentStatus   String?            @map("payment_status") @db.VarChar(20) // "PENDING", "PARTIAL", "PAID"
  amountPaid      Decimal?           @default(0) @map("amount_paid") @db.Decimal(12, 2) // Amount already paid

  // File attachment (single primary file)
  fileUrl         String?            @map("file_url") @db.Text
  fileName        String?            @map("file_name") @db.VarChar(255)
  fileSize        Int?               @map("file_size")
  fileType        String?            @map("file_type") @db.VarChar(100)

  // Timestamps
  createdAt       DateTime           @default(now()) @map("created_at")
  updatedAt       DateTime           @updatedAt @map("updated_at")

  doctor          Doctor             @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  sale            Sale?              @relation("SaleLedgerEntries", fields: [saleId], references: [id], onDelete: SetNull)
  purchase        Purchase?          @relation("PurchaseLedgerEntries", fields: [purchaseId], references: [id], onDelete: SetNull)
  client          Client?            @relation("ClientLedgerEntries", fields: [clientId], references: [id], onDelete: SetNull)
  supplier        Proveedor?         @relation("ProveedorLedgerEntries", fields: [supplierId], references: [id], onDelete: SetNull)
  attachments     LedgerAttachment[]
  facturas        LedgerFactura[]
  facturasXml     LedgerFacturaXml[]

  @@unique([doctorId, internalId])
  @@index([doctorId])
  @@index([doctorId, entryType])
  @@index([doctorId, transactionDate])
  @@index([doctorId, area, subarea])
  @@index([doctorId, porRealizar])
  @@map("ledger_entries")
  @@schema("practice_management")
}

model LedgerAttachment {
  id             Int          @id @default(autoincrement())
  ledgerEntryId  Int          @map("ledger_entry_id")
  fileName       String       @map("file_name") @db.VarChar(255)
  fileUrl        String       @map("file_url") @db.Text
  fileSize       Int?         @map("file_size")
  fileType       String?      @map("file_type") @db.VarChar(100)
  attachmentType String       @default("file") @map("attachment_type") @db.VarChar(20)
  createdAt      DateTime     @default(now()) @map("created_at")

  ledgerEntry    LedgerEntry  @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)

  @@index([ledgerEntryId])
  @@map("ledger_attachments")
  @@schema("practice_management")
}

model LedgerFactura {
  id            Int          @id @default(autoincrement())
  ledgerEntryId Int          @map("ledger_entry_id")
  fileName      String       @map("file_name") @db.VarChar(255)
  fileUrl       String       @map("file_url") @db.Text
  fileSize      Int?         @map("file_size")
  fileType      String?      @map("file_type") @db.VarChar(100)
  folio         String?      @db.VarChar(100)
  uuid          String?      @db.VarChar(100)
  rfcEmisor     String?      @map("rfc_emisor") @db.VarChar(20)
  rfcReceptor   String?      @map("rfc_receptor") @db.VarChar(20)
  total         Decimal?     @db.Decimal(12, 2)
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")

  ledgerEntry   LedgerEntry  @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)

  @@index([ledgerEntryId])
  @@map("ledger_facturas")
  @@schema("practice_management")
}

model LedgerFacturaXml {
  id            Int          @id @default(autoincrement())
  ledgerEntryId Int          @map("ledger_entry_id")
  fileName      String       @map("file_name") @db.VarChar(255)
  fileUrl       String       @map("file_url") @db.Text
  fileSize      Int?         @map("file_size")
  xmlContent    String?      @map("xml_content") @db.Text
  folio         String?      @db.VarChar(100)
  uuid          String?      @unique @db.VarChar(100)
  rfcEmisor     String?      @map("rfc_emisor") @db.VarChar(20)
  rfcReceptor   String?      @map("rfc_receptor") @db.VarChar(20)
  total         Decimal?     @db.Decimal(12, 2)
  subtotal      Decimal?     @db.Decimal(12, 2)
  iva           Decimal?     @db.Decimal(12, 2)
  fecha         DateTime?    @db.Timestamp(6)
  metodoPago    String?      @map("metodo_pago") @db.VarChar(50)
  formaPago     String?      @map("forma_pago") @db.VarChar(50)
  moneda        String?      @db.VarChar(10)
  notes         String?      @db.Text
  createdAt     DateTime     @default(now()) @map("created_at")

  ledgerEntry   LedgerEntry  @relation(fields: [ledgerEntryId], references: [id], onDelete: Cascade)

  @@index([ledgerEntryId])
  @@index([uuid])
  @@map("ledger_facturas_xml")
  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 7. SALES - QUOTATIONS (COTIZACIONES)
// -----------------------------------------------------------------------------

model Quotation {
  id                 Int              @id @default(autoincrement())
  doctorId           String           @map("doctor_id")
  clientId           Int              @map("client_id")

  // Quote Information
  quotationNumber    String           @unique @map("quotation_number") @db.VarChar(50)
  issueDate          DateTime         @map("issue_date") @db.Date
  validUntil         DateTime         @map("valid_until") @db.Date

  // Status
  status             QuotationStatus  @default(DRAFT)

  // Pricing
  subtotal           Decimal          @db.Decimal(12, 2)
  taxRate            Decimal?         @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16% IVA
  tax                Decimal?         @db.Decimal(12, 2)
  total              Decimal          @db.Decimal(12, 2)

  // Additional Info
  notes              String?          @db.Text
  termsAndConditions String?          @map("terms_and_conditions") @db.Text

  // Timestamps
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  // Relations
  doctor             Doctor           @relation("DoctorQuotations", fields: [doctorId], references: [id], onDelete: Cascade)
  client             Client           @relation("ClientQuotations", fields: [clientId], references: [id], onDelete: Restrict)
  items              QuotationItem[]
  sales              Sale[]           @relation("QuotationSales")
  purchases          Purchase[]       @relation("QuotationPurchases")

  @@index([doctorId, status])
  @@index([doctorId, clientId])
  @@index([quotationNumber])
  @@index([issueDate])
  @@map("quotations")
  @@schema("practice_management")
}

model QuotationItem {
  id            Int        @id @default(autoincrement())
  quotationId   Int        @map("quotation_id")

  // Item can be a product or custom service
  productId     Int?       @map("product_id")
  itemType      String     @default("product") @map("item_type") @db.VarChar(20) // "product" or "service"

  // Item Details (stored to preserve quote even if product changes)
  description   String     @db.VarChar(500)
  sku           String?    @db.VarChar(100)

  // Pricing
  quantity      Decimal    @db.Decimal(10, 4)
  unit          String?    @db.VarChar(50) // "pza", "kg", "servicio"
  unitPrice     Decimal    @map("unit_price") @db.Decimal(10, 2)
  subtotal      Decimal    @db.Decimal(12, 2)

  // Discount (per-item)
  discountRate  Decimal?   @default(0) @map("discount_rate") @db.Decimal(5, 4) // 0.10 = 10%

  // Tax (per-item)
  taxRate       Decimal?   @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16%
  taxAmount     Decimal?   @default(0) @map("tax_amount") @db.Decimal(12, 2)

  // Display Order
  order         Int        @default(0)

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  quotation     Quotation  @relation(fields: [quotationId], references: [id], onDelete: Cascade)
  product       Product?   @relation("QuotationItemProduct", fields: [productId], references: [id], onDelete: SetNull)

  @@index([quotationId])
  @@index([productId])
  @@map("quotation_items")
  @@schema("practice_management")
}

enum QuotationStatus {
  DRAFT      // Borrador
  SENT       // Enviada
  APPROVED   // Aprobada
  REJECTED   // Rechazada
  EXPIRED    // Vencida
  CANCELLED  // Cancelada

  @@schema("practice_management")
}

// -----------------------------------------------------------------------------
// 8. SALES - VENTAS EN FIRME (FIRM SALES)
// -----------------------------------------------------------------------------

model Sale {
  id                 Int              @id @default(autoincrement())
  doctorId           String           @map("doctor_id")
  clientId           Int              @map("client_id")
  quotationId        Int?             @map("quotation_id") // Optional: links to original quotation

  // Sale Information
  saleNumber         String           @unique @map("sale_number") @db.VarChar(50) // VTA-2026-001
  saleDate           DateTime         @map("sale_date") @db.Date
  deliveryDate       DateTime?        @map("delivery_date") @db.Date

  // Status
  status             SaleStatus       @default(PENDING)

  // Pricing
  subtotal           Decimal          @db.Decimal(12, 2)
  taxRate            Decimal?         @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16% IVA
  tax                Decimal?         @db.Decimal(12, 2)
  total              Decimal          @db.Decimal(12, 2)

  // Payment tracking
  amountPaid         Decimal?         @default(0) @map("amount_paid") @db.Decimal(12, 2)
  paymentStatus      PaymentStatus    @default(PENDING) @map("payment_status")

  // Additional Info
  notes              String?          @db.Text
  termsAndConditions String?          @map("terms_and_conditions") @db.Text

  // Timestamps
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  // Relations
  doctor             Doctor           @relation("DoctorSales", fields: [doctorId], references: [id], onDelete: Cascade)
  client             Client           @relation("ClientSales", fields: [clientId], references: [id], onDelete: Restrict)
  quotation          Quotation?       @relation("QuotationSales", fields: [quotationId], references: [id], onDelete: SetNull)
  items              SaleItem[]
  ledgerEntries      LedgerEntry[]    @relation("SaleLedgerEntries")

  @@index([doctorId, status])
  @@index([doctorId, clientId])
  @@index([doctorId, paymentStatus])
  @@index([saleNumber])
  @@index([saleDate])
  @@index([quotationId])
  @@map("sales")
  @@schema("practice_management")
}

model SaleItem {
  id            Int        @id @default(autoincrement())
  saleId        Int        @map("sale_id")

  // Item can be a product or custom service
  productId     Int?       @map("product_id")
  itemType      String     @default("product") @map("item_type") @db.VarChar(20) // "product" or "service"

  // Item Details (stored to preserve sale even if product changes)
  description   String     @db.VarChar(500)
  sku           String?    @db.VarChar(100)

  // Pricing
  quantity      Decimal    @db.Decimal(10, 4)
  unit          String?    @db.VarChar(50) // "pza", "kg", "servicio"
  unitPrice     Decimal    @map("unit_price") @db.Decimal(10, 2)
  subtotal      Decimal    @db.Decimal(12, 2)

  // Discount (per-item)
  discountRate  Decimal?   @default(0) @map("discount_rate") @db.Decimal(5, 4) // 0.10 = 10%

  // Tax (per-item)
  taxRate       Decimal?   @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16%
  taxAmount     Decimal?   @default(0) @map("tax_amount") @db.Decimal(12, 2)

  // Display Order
  order         Int        @default(0)

  // Timestamps
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  sale          Sale       @relation(fields: [saleId], references: [id], onDelete: Cascade)
  product       Product?   @relation("SaleItemProduct", fields: [productId], references: [id], onDelete: SetNull)

  @@index([saleId])
  @@index([productId])
  @@map("sale_items")
  @@schema("practice_management")
}

// ============================================
// PURCHASES (COMPRAS)
// ============================================

model Purchase {
  id                 Int              @id @default(autoincrement())
  doctorId           String           @map("doctor_id")
  supplierId         Int              @map("supplier_id")
  quotationId        Int?             @map("quotation_id") // Optional: links to original quotation

  // Purchase Information
  purchaseNumber     String           @unique @map("purchase_number") @db.VarChar(50) // CMP-2026-001
  purchaseDate       DateTime         @map("purchase_date") @db.Date
  deliveryDate       DateTime?        @map("delivery_date") @db.Date

  // Status
  status             PurchaseStatus   @default(PENDING)

  // Pricing
  subtotal           Decimal          @db.Decimal(12, 2)
  taxRate            Decimal?         @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16% IVA
  tax                Decimal?         @db.Decimal(12, 2)
  total              Decimal          @db.Decimal(12, 2)

  // Payment tracking
  amountPaid         Decimal?         @default(0) @map("amount_paid") @db.Decimal(12, 2)
  paymentStatus      PaymentStatus    @default(PENDING) @map("payment_status")

  // Additional Info
  notes              String?          @db.Text
  termsAndConditions String?          @map("terms_and_conditions") @db.Text

  // Timestamps
  createdAt          DateTime         @default(now()) @map("created_at")
  updatedAt          DateTime         @updatedAt @map("updated_at")

  // Relations
  doctor             Doctor           @relation("DoctorPurchases", fields: [doctorId], references: [id], onDelete: Cascade)
  supplier           Proveedor        @relation("ProveedorPurchases", fields: [supplierId], references: [id], onDelete: Restrict)
  quotation          Quotation?       @relation("QuotationPurchases", fields: [quotationId], references: [id], onDelete: SetNull)
  items              PurchaseItem[]
  ledgerEntries      LedgerEntry[]    @relation("PurchaseLedgerEntries")

  @@index([doctorId, status])
  @@index([doctorId, supplierId])
  @@index([doctorId, paymentStatus])
  @@index([purchaseNumber])
  @@index([purchaseDate])
  @@index([quotationId])
  @@map("purchases")
  @@schema("practice_management")
}

model PurchaseItem {
  id            Int          @id @default(autoincrement())
  purchaseId    Int          @map("purchase_id")

  // Item can be a product or custom service
  productId     Int?         @map("product_id")
  itemType      String       @default("product") @map("item_type") @db.VarChar(20) // "product" or "service"

  // Item Details (stored to preserve purchase even if product changes)
  description   String       @db.VarChar(500)
  sku           String?      @db.VarChar(100)

  // Pricing
  quantity      Decimal      @db.Decimal(10, 4)
  unit          String?      @db.VarChar(50) // "pza", "kg", "servicio"
  unitPrice     Decimal      @map("unit_price") @db.Decimal(10, 2)
  subtotal      Decimal      @db.Decimal(12, 2)

  // Discount (per-item)
  discountRate  Decimal?     @default(0) @map("discount_rate") @db.Decimal(5, 4) // 0.10 = 10%

  // Tax (per-item)
  taxRate       Decimal?     @default(0.16) @map("tax_rate") @db.Decimal(5, 4) // 0.16 = 16%
  taxAmount     Decimal?     @default(0) @map("tax_amount") @db.Decimal(12, 2)

  // Display Order
  order         Int          @default(0)

  // Timestamps
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  // Relations
  purchase      Purchase     @relation(fields: [purchaseId], references: [id], onDelete: Cascade)
  product       Product?     @relation("PurchaseItemProduct", fields: [productId], references: [id], onDelete: SetNull)

  @@index([purchaseId])
  @@index([productId])
  @@map("purchase_items")
  @@schema("practice_management")
}

enum SaleStatus {
  PENDING      // Pendiente
  CONFIRMED    // Confirmada
  PROCESSING   // En proceso
  SHIPPED      // Enviada
  DELIVERED    // Entregada
  CANCELLED    // Cancelada

  @@schema("practice_management")
}

enum PurchaseStatus {
  PENDING      // Pendiente
  CONFIRMED    // Confirmada
  PROCESSING   // En proceso
  SHIPPED      // Enviada
  RECEIVED     // Recibida
  CANCELLED    // Cancelada

  @@schema("practice_management")
}

enum PaymentStatus {
  PENDING      // Pendiente
  PARTIAL      // Pago parcial
  PAID         // Pagada

  @@schema("practice_management")
}

// ============================================================================
// MEDICAL RECORDS DOMAIN (EMR)
// ============================================================================

// -----------------------------------------------------------------------------
// PHASE 1: PATIENT PROFILES + BASIC ENCOUNTERS
// -----------------------------------------------------------------------------

/// Patient Master Record
/// This is the long-lived identity and baseline medical information
model Patient {
  id          String   @id @default(cuid())
  doctorId    String   @map("doctor_id")

  // Identification
  internalId  String   @map("internal_id") @db.VarChar(50)  // Doctor's own patient ID
  firstName   String   @map("first_name") @db.VarChar(100)
  lastName    String   @map("last_name") @db.VarChar(100)
  dateOfBirth DateTime @map("date_of_birth") @db.Date
  sex         String   @db.VarChar(20)  // "male", "female", "other"

  // Contact Information (optional)
  email       String?  @db.VarChar(255)
  phone       String?  @db.VarChar(50)
  address     String?  @db.Text
  city        String?  @db.VarChar(100)
  state       String?  @db.VarChar(100)
  postalCode  String?  @map("postal_code") @db.VarChar(20)

  // Emergency Contact (optional)
  emergencyContactName  String? @map("emergency_contact_name") @db.VarChar(200)
  emergencyContactPhone String? @map("emergency_contact_phone") @db.VarChar(50)
  emergencyContactRelation String? @map("emergency_contact_relation") @db.VarChar(100)

  // Administrative
  firstVisitDate DateTime?  @map("first_visit_date") @db.Date
  lastVisitDate  DateTime?  @map("last_visit_date") @db.Date
  status         String     @default("active") @db.VarChar(20)  // active, inactive, archived
  tags           String[]   // ["diabetic", "post-op", "chronic"]

  // Medical Baseline (versioned through PatientMedicalHistory)
  currentAllergies      String?  @map("current_allergies") @db.Text
  currentChronicConditions String? @map("current_chronic_conditions") @db.Text
  currentMedications    String?  @map("current_medications") @db.Text
  bloodType             String?  @map("blood_type") @db.VarChar(10)

  // Notes (non-visit-specific)
  generalNotes  String?  @map("general_notes") @db.Text

  // Profile photo (optional)
  photoUrl      String?  @map("photo_url") @db.Text

  // Timestamps
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  doctor               Doctor                 @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  encounters           ClinicalEncounter[]
  medicalHistory       PatientMedicalHistory[]
  media                PatientMedia[]
  prescriptions        Prescription[]
  auditLogs            PatientAuditLog[]

  @@unique([doctorId, internalId])
  @@index([doctorId, status])
  @@index([doctorId, firstName, lastName])
  @@index([doctorId, lastVisitDate])
  @@map("patients")
  @@schema("medical_records")
}

/// Versioned Medical History
/// Tracks changes to patient's baseline medical information
model PatientMedicalHistory {
  id          Int      @id @default(autoincrement())
  patientId   String   @map("patient_id")
  doctorId    String   @map("doctor_id")

  // What changed
  fieldName   String   @map("field_name") @db.VarChar(100)  // "allergies", "chronic_conditions", etc.
  oldValue    String?  @map("old_value") @db.Text
  newValue    String?  @map("new_value") @db.Text

  // Who and when
  changedBy   String   @map("changed_by")  // userId who made the change
  changeReason String? @map("change_reason") @db.Text
  changedAt   DateTime @default(now()) @map("changed_at")

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, changedAt])
  @@index([doctorId, changedAt])
  @@map("patient_medical_history")
  @@schema("medical_records")
}

/// Clinical Encounter (Visit)
/// Each visit is a sealed clinical event with structured notes
model ClinicalEncounter {
  id              String   @id @default(cuid())
  patientId       String   @map("patient_id")
  doctorId        String   @map("doctor_id")

  // Encounter metadata
  encounterDate   DateTime @map("encounter_date")
  encounterType   String   @map("encounter_type") @db.VarChar(50)  // consultation, follow-up, emergency, telemedicine
  chiefComplaint  String   @map("chief_complaint") @db.Text  // Reason for visit
  location        String?  @db.VarChar(100)  // clinic name or "online"

  // Status
  status          String   @default("draft") @db.VarChar(20)  // draft, completed, amended

  // PHASE 1: Simple notes (will be replaced by structured SOAP in Phase 2)
  clinicalNotes   String?  @map("clinical_notes") @db.Text

  // PHASE 2: Structured SOAP notes (added in Phase 2)
  subjective      String?  @db.Text  // Patient-reported symptoms
  objective       String?  @db.Text  // Physical examination findings
  assessment      String?  @db.Text  // Diagnoses and clinical impressions
  plan            String?  @db.Text  // Treatment plan and follow-up

  // Vitals (Phase 2)
  vitalsBloodPressure String? @map("vitals_blood_pressure") @db.VarChar(20)
  vitalsHeartRate     Int?    @map("vitals_heart_rate")
  vitalsTemperature   Decimal? @map("vitals_temperature") @db.Decimal(4, 1)
  vitalsWeight        Decimal? @map("vitals_weight") @db.Decimal(5, 2)
  vitalsHeight        Decimal? @map("vitals_height") @db.Decimal(5, 2)
  vitalsOxygenSat     Int?    @map("vitals_oxygen_sat")
  vitalsOther         String? @map("vitals_other") @db.Text

  // Follow-up
  followUpDate    DateTime? @map("follow_up_date") @db.Date
  followUpNotes   String?   @map("follow_up_notes") @db.Text

  // Audit
  createdBy       String    @map("created_by")  // userId who created
  completedAt     DateTime? @map("completed_at")
  amendedAt       DateTime? @map("amended_at")
  amendmentReason String?   @map("amendment_reason") @db.Text

  // Timestamps
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  // Relations
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  versions        EncounterVersion[]
  media           PatientMedia[]
  prescriptions   Prescription[]

  @@index([patientId, encounterDate])
  @@index([doctorId, encounterDate])
  @@index([doctorId, status])
  @@map("clinical_encounters")
  @@schema("medical_records")
}

// -----------------------------------------------------------------------------
// PHASE 2: ENCOUNTER VERSIONING
// -----------------------------------------------------------------------------

/// Encounter Version History
/// Preserves previous versions when encounter is edited
model EncounterVersion {
  id              Int      @id @default(autoincrement())
  encounterId     String   @map("encounter_id")
  versionNumber   Int      @map("version_number")

  // Snapshot of encounter at this version
  encounterData   Json     @map("encounter_data")  // Full JSON snapshot

  // Audit
  createdBy       String   @map("created_by")
  changeReason    String?  @map("change_reason") @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  encounter       ClinicalEncounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@unique([encounterId, versionNumber])
  @@index([encounterId, createdAt])
  @@map("encounter_versions")
  @@schema("medical_records")
}

// -----------------------------------------------------------------------------
// PHASE 3: MEDIA MANAGEMENT
// -----------------------------------------------------------------------------

/// Patient Media Assets
/// Images, videos, audio linked to encounters or patient profile
model PatientMedia {
  id              String   @id @default(cuid())
  patientId       String   @map("patient_id")
  doctorId        String   @map("doctor_id")
  encounterId     String?  @map("encounter_id")  // Optional link to specific encounter

  // Media metadata
  mediaType       String   @map("media_type") @db.VarChar(20)  // image, video, audio
  fileName        String   @map("file_name") @db.VarChar(255)
  fileUrl         String   @map("file_url") @db.Text
  fileSize        Int?     @map("file_size")
  mimeType        String?  @map("mime_type") @db.VarChar(100)

  // Thumbnail (for videos)
  thumbnailUrl    String?  @map("thumbnail_url") @db.Text

  // Clinical context
  category        String?  @db.VarChar(100)  // "wound", "x-ray", "dermatology", "lab-result"
  bodyArea        String?  @map("body_area") @db.VarChar(100)
  captureDate     DateTime @map("capture_date")
  description     String?  @db.Text
  doctorNotes     String?  @map("doctor_notes") @db.Text

  // Privacy
  visibility      String   @default("internal") @db.VarChar(20)  // internal, exportable

  // Timestamps
  uploadedBy      String   @map("uploaded_by")
  createdAt       DateTime @default(now()) @map("created_at")

  // Relations
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  encounter       ClinicalEncounter? @relation(fields: [encounterId], references: [id], onDelete: SetNull)

  @@index([patientId, captureDate])
  @@index([doctorId, mediaType])
  @@index([encounterId])
  @@map("patient_media")
  @@schema("medical_records")
}

// -----------------------------------------------------------------------------
// PHASE 4: PRESCRIPTIONS
// -----------------------------------------------------------------------------

/// Prescription Record
/// First-class prescription entity with PDF generation
model Prescription {
  id              String   @id @default(cuid())
  patientId       String   @map("patient_id")
  doctorId        String   @map("doctor_id")
  encounterId     String?  @map("encounter_id")  // Optional link to encounter

  // Prescription metadata
  prescriptionDate DateTime @map("prescription_date")
  status          String   @default("draft") @db.VarChar(20)  // draft, issued, cancelled, expired

  // Doctor details (copied at time of issuance for legal integrity)
  doctorFullName  String   @map("doctor_full_name") @db.VarChar(255)
  doctorLicense   String   @map("doctor_license") @db.VarChar(100)
  doctorSignature String?  @map("doctor_signature") @db.Text  // URL to signature image

  // Clinical context
  diagnosis       String?  @db.Text
  clinicalNotes   String?  @map("clinical_notes") @db.Text

  // PDF
  pdfUrl          String?  @map("pdf_url") @db.Text
  pdfGeneratedAt  DateTime? @map("pdf_generated_at")

  // Versioning (for drafts)
  versionNumber   Int      @default(1) @map("version_number")

  // Audit
  issuedBy        String?  @map("issued_by")  // userId who issued
  issuedAt        DateTime? @map("issued_at")
  cancelledAt     DateTime? @map("cancelled_at")
  cancellationReason String? @map("cancellation_reason") @db.Text
  expiresAt       DateTime? @map("expires_at")

  // Timestamps
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  patient         Patient           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  encounter       ClinicalEncounter? @relation(fields: [encounterId], references: [id], onDelete: SetNull)
  medications     PrescriptionMedication[]

  @@index([patientId, prescriptionDate])
  @@index([doctorId, status])
  @@index([doctorId, prescriptionDate])
  @@map("prescriptions")
  @@schema("medical_records")
}

/// Prescription Medications
/// Individual medication items within a prescription
model PrescriptionMedication {
  id              Int      @id @default(autoincrement())
  prescriptionId  String   @map("prescription_id")

  // Medication details
  drugName        String   @map("drug_name") @db.VarChar(255)
  presentation    String?  @db.VarChar(100)  // "tablet", "syrup", "injection"
  dosage          String   @db.VarChar(100)  // "500mg", "10ml"
  frequency       String   @db.VarChar(100)  // "Every 8 hours", "Twice daily"
  duration        String?  @db.VarChar(100)  // "7 days", "2 weeks"
  quantity        String?  @db.VarChar(50)   // "21 tablets", "1 bottle"
  instructions    String   @db.Text          // "Take with food"
  warnings        String?  @db.Text          // "Do not drive"

  // Display order
  order           Int      @default(0)

  prescription    Prescription @relation(fields: [prescriptionId], references: [id], onDelete: Cascade)

  @@index([prescriptionId, order])
  @@map("prescription_medications")
  @@schema("medical_records")
}

// -----------------------------------------------------------------------------
// AUDIT & COMPLIANCE
// -----------------------------------------------------------------------------

/// Patient Audit Log
/// Tracks all access and modifications to patient records
model PatientAuditLog {
  id              Int      @id @default(autoincrement())
  patientId       String   @map("patient_id")
  doctorId        String   @map("doctor_id")

  // Action details
  action          String   @db.VarChar(100)  // "view_profile", "create_encounter", "edit_encounter", "issue_prescription"
  resourceType    String   @map("resource_type") @db.VarChar(50)  // "patient", "encounter", "prescription"
  resourceId      String?  @map("resource_id")  // ID of the resource acted upon

  // Changes (optional)
  changes         Json?    // JSON of what changed

  // User context
  userId          String   @map("user_id")
  userRole        String   @map("user_role") @db.VarChar(50)
  ipAddress       String?  @map("ip_address") @db.VarChar(45)
  userAgent       String?  @map("user_agent") @db.Text

  // Timestamp
  timestamp       DateTime @default(now())

  patient         Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@index([patientId, timestamp])
  @@index([doctorId, timestamp])
  @@index([userId, timestamp])
  @@map("patient_audit_logs")
  @@schema("medical_records")
}
